#!/bin/sh

SESSION_NAME="$(basename "$PWD" | tr . -)"

session_exists() {
  tmux list-sessions | sed -E 's/:.*$//' | grep -q "^$SESSION_NAME$"
}

if [ -z "$TMUX" ]; then
  if ! session_exists; then
    # Create a new session.
    tmux new-session -d -s "$SESSION_NAME"

    # Rename the window.
    tmux rename-window -t 1 code

    # Split window for test and terminal panes.
    tmux split-window -t 1 -p 40 -h
    tmux split-window -t 2 -p 30 -v

    # Select the vim pane.
    tmux select-pane -t 1

    # Wait for the panes to initialize.
    sleep 0.5

    # Launch vim and attach vim-tmux-runner to the second pane.
    tmux send-keys -t 1 'vim .' C-m
    tmux send-keys -t 1 ':VtrAttachToPane 2' C-m

    # Display the git status in the terminal pane.
    tmux send-keys -t 3 'git status' C-m
  fi

  # Attach to the session.
  tmux attach-session -t $SESSION_NAME:1
else
  tmux switch-client -t "$SESSION_NAME"
fi
